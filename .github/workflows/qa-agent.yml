name: QA Agent - Auto Test Generation

on:
  push:
    branches-ignore:
      - main
      - develop

  pull_request:
    types:
      - opened
  workflow_dispatch:
jobs:
  qa-agent:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      with:
         ref: ${{ github.event.pull_request.head.ref || github.ref }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install anthropic requests pytest dnspython

      - name: Copy Slack notifications module
        run: |
          cp slack_notifications.py agents/ || echo "slack_notifications.py not found in root"
      
      
      - name: Run QA Agent
        if: github.event.pull_request.number
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} 
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          NOTION_METRICS_DB_ID: ${{ secrets.NOTION_METRICS_DB_ID }}
        run: |
          python agents/qa_agent.py
      
      - name: Run Generated Tests
        continue-on-error: true
        run: |
          if [ -f "tests/test_generated.py" ]; then
            export PYTHONPATH="${PYTHONPATH}:$(pwd)"
            pytest tests/test_generated.py -v --tb=short > test_results.txt 2>&1 || true
          else
            echo "No tests generated" > test_results.txt
          fi
      
      - name: Post to GitHub and Notion
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import requests
          import re
          
          # Read test results
          try:
              with open('test_results.txt', 'r') as f:
                  test_results = f.read()
          except FileNotFoundError:
              test_results = "No test results available"
          
          # Parse test metrics
          def parse_test_metrics(results):
              metrics = {
                  'total': 0,
                  'passed': 0,
                  'failed': 0,
                  'errors': 0,
                  'skipped': 0,
                  'completion_pct': 0,
                  'test_names': []
              }
              
              passed_match = re.search(r'(\d+) passed', results)
              failed_match = re.search(r'(\d+) failed', results)
              error_match = re.search(r'(\d+) error', results)
              skipped_match = re.search(r'(\d+) skipped', results)
              
              if passed_match:
                  metrics['passed'] = int(passed_match.group(1))
              if failed_match:
                  metrics['failed'] = int(failed_match.group(1))
              if error_match:
                  metrics['errors'] = int(error_match.group(1))
              if skipped_match:
                  metrics['skipped'] = int(skipped_match.group(1))
              
              metrics['total'] = metrics['passed'] + metrics['failed'] + metrics['errors'] + metrics['skipped']
              
              if metrics['total'] > 0:
                  metrics['completion_pct'] = round((metrics['passed'] / metrics['total']) * 100, 1)
              
              test_pattern = r'(test_\w+)\s+(PASSED|FAILED|ERROR|SKIPPED)'
              for match in re.finditer(test_pattern, results):
                  test_name = match.group(1)
                  status = match.group(2)
                  metrics['test_names'].append({
                      'name': test_name,
                      'status': status
                  })
              
              return metrics
          
          metrics = parse_test_metrics(test_results)
          
          # Get PR details
          pr_number = os.environ['PR_NUMBER']
          repo = os.environ['GITHUB_REPOSITORY']
          token = os.environ['GITHUB_TOKEN']
          
          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json"
          }
          
          pr_response = requests.get(
              f"https://api.github.com/repos/{repo}/pulls/{pr_number}",
              headers=headers
          )
          pr_title = pr_response.json().get('title', 'Unknown PR')
          
          # Post to GitHub
          gh_comment = f"""## üß™ QA Agent Report
          
          **Automated Test Generation Complete**
          
          ### üìä Test Summary
          - **Total Tests:** {metrics['total']}
          - **Passed:** ‚úÖ {metrics['passed']}
          - **Failed:** ‚ùå {metrics['failed']}
          - **Errors:** üî¥ {metrics['errors']}
          - **Completion:** {metrics['completion_pct']}%
          
          <details>
          <summary>üìã Detailed Results</summary>
          
          ```
          {test_results[:2000]}
          ```
          </details>
          
          ---
          *Generated by QA Agent*"""
          
          gh_response = requests.post(
              f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments",
              headers=headers,
              json={"body": gh_comment}
          )
          
          if gh_response.status_code == 201:
              print("‚úÖ Posted to GitHub successfully!")
          else:
              print(f"‚ö†Ô∏è GitHub post failed: {gh_response.status_code}")
          
          # Post to Notion with detailed metrics
          notion_token = os.environ.get('NOTION_TOKEN')
          notion_db = os.environ.get('NOTION_DATABASE_ID')
          
          if notion_token and notion_db:
              print("üìù Posting to Notion...")
              
              notion_headers = {
                  "Authorization": f"Bearer {notion_token}",
                  "Content-Type": "application/json",
                  "Notion-Version": "2022-06-28"
              }
              
              test_breakdown = []
              
              test_breakdown.append({
                  "object": "block",
                  "type": "heading_2",
                  "heading_2": {
                      "rich_text": [{"type": "text", "text": {"content": "üìä Test Execution Summary"}}]
                  }
              })
              
              metrics_text = f"Total: {metrics['total']} | Passed: {metrics['passed']} | Failed: {metrics['failed']} | Completion: {metrics['completion_pct']}%"
              test_breakdown.append({
                  "object": "block",
                  "type": "callout",
                  "callout": {
                      "rich_text": [{"type": "text", "text": {"content": metrics_text}}],
                      "icon": {"emoji": "üìà"}
                  }
              })
              
              if metrics['test_names']:
                  test_breakdown.append({
                      "object": "block",
                      "type": "heading_3",
                      "heading_3": {
                          "rich_text": [{"type": "text", "text": {"content": "Test Cases Executed"}}]
                      }
                  })
                  
                  for test in metrics['test_names'][:20]:
                      emoji = "‚úÖ" if test['status'] == "PASSED" else "‚ùå" if test['status'] == "FAILED" else "üî¥"
                      test_text = f"{emoji} {test['name']} - {test['status']}"
                      
                      test_breakdown.append({
                          "object": "block",
                          "type": "bulleted_list_item",
                          "bulleted_list_item": {
                              "rich_text": [{"type": "text", "text": {"content": test_text}}]
                          }
                      })
              
              test_breakdown.append({
                  "object": "block",
                  "type": "heading_3",
                  "heading_3": {
                      "rich_text": [{"type": "text", "text": {"content": "Raw Test Output"}}]
                  }
              })
              
              truncated_results = test_results[:1500] if len(test_results) > 1500 else test_results
              test_breakdown.append({
                  "object": "block",
                  "type": "code",
                  "code": {
                      "rich_text": [{"type": "text", "text": {"content": truncated_results}}],
                      "language": "plain text"
                  }
              })
              
              notion_data = {
                  "parent": {"database_id": notion_db},
                  "properties": {
                      "Name": {
                          "title": [{"text": {"content": f"QA Report: {pr_title[:70]} ({metrics['completion_pct']}%)"}}]
                      },
                      "Agent Type": {
                          "select": {"name": "QA"}
                      },
                      "Issue/PR Number": {
                          "number": int(pr_number)
                      },
                      "Status": {
                          "select": {"name": "Complete"}
                      }
                  },
                  "children": [
                      {
                          "object": "block",
                          "type": "heading_2",
                          "heading_2": {
                              "rich_text": [{"type": "text", "text": {"content": "üß™ QA Test Report"}}]
                          }
                      },
                      {
                          "object": "block",
                          "type": "paragraph",
                          "paragraph": {
                              "rich_text": [{"type": "text", "text": {"content": f"PR: {pr_title}"}}]
                          }
                      },
                      {
                          "object": "block",
                          "type": "divider",
                          "divider": {}
                      }
                  ] + test_breakdown
              }
              
              notion_response = requests.post(
                  "https://api.notion.com/v1/pages",
                  headers=notion_headers,
                  json=notion_data
              )
              
              if notion_response.status_code == 200:
                  print("‚úÖ Posted to Notion successfully!")
                  print(f"   - Total Tests: {metrics['total']}")
                  print(f"   - Passed: {metrics['passed']}")
                  print(f"   - Completion: {metrics['completion_pct']}%")
              else:
                  print(f"‚ö†Ô∏è Notion post failed: {notion_response.status_code}")
                  print(notion_response.text)
          else:
              print("‚ö†Ô∏è Notion credentials not configured")
          PYTHON_SCRIPT
