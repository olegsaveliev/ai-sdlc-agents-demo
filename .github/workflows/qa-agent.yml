name: QA Agent - Auto Test Generation

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

jobs:
  qa-agent:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install anthropic requests pytest
      
      - name: Run QA Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python agents/qa_agent.py
      
      - name: Run Generated Tests
        id: run-tests
        continue-on-error: true
        run: |
          if [ -f "tests/test_generated.py" ]; then
            pytest tests/test_generated.py -v --tb=short > test_results.txt 2>&1 || true
            echo "Tests executed"
          else
            echo "No tests generated" > test_results.txt
          fi
      
      - name: Post Results Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import requests
          
          # Read test results
          try:
              with open('test_results.txt', 'r') as f:
                  results = f.read()[:2000]
          except FileNotFoundError:
              results = "No test results available"
          
          # Create comment body
          comment_body = f"""## üß™ QA Agent Report

**Automated Test Generation Complete**

Tests have been generated and executed for this PR.

<details>
<summary>üìä Test Results</summary>

```
{results}
```
</details>

---
*Generated by QA Agent*"""
          
          # Post comment to GitHub
          pr_number = os.environ['PR_NUMBER']
          repo = os.environ['GITHUB_REPOSITORY']
          token = os.environ['GITHUB_TOKEN']
          
          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json"
          }
          
          payload = {"body": comment_body}
          
          response = requests.post(
              f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments",
              headers=headers,
              json=payload
          )
          
          if response.status_code == 201:
              print("‚úÖ Comment posted successfully!")
          else:
              print(f"‚ùå Failed to post comment: {response.status_code}")
          PYTHON_SCRIPT
