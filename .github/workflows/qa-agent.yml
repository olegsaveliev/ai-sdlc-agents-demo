name: QA Agent - Auto Test Generation

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

jobs:
  qa-agent:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install anthropic requests pytest
      
      - name: Run QA Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          python agents/qa_agent.py
      
      - name: Run Generated Tests
        continue-on-error: true
        run: |
          if [ -f "tests/test_generated.py" ]; then
            # Add current directory to Python path so imports work
            export PYTHONPATH="${PYTHONPATH}:$(pwd)"
            pytest tests/test_generated.py -v --tb=short > test_results.txt 2>&1 || true
          else
            echo "No tests generated" > test_results.txt
          fi
      
      - name: Post Comment
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python3 -c "
          import os, requests
          try:
              with open('test_results.txt') as f: results = f.read()[:2000]
          except: results = 'No results'
          body = '## ðŸ§ª QA Agent Report\n\n**Test Generation Complete**\n\n<details><summary>ðŸ“Š Results</summary>\n\n\`\`\`\n' + results + '\n\`\`\`\n</details>\n\n---\n*QA Agent*'
          r = requests.post(f\"https://api.github.com/repos/{os.environ['GITHUB_REPOSITORY']}/issues/{os.environ['PR_NUMBER']}/comments\", headers={'Authorization': f\"Bearer {os.environ['GITHUB_TOKEN']}\", 'Accept': 'application/vnd.github+json'}, json={'body': body})
          print('Posted!' if r.status_code == 201 else f'Failed: {r.status_code}')
          "
