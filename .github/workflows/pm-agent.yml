name: PM Agent - Daily Standup Report

on:
  schedule:
    - cron: '0 9 * * 1-5'
  workflow_dispatch:

jobs:
  pm-agent:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install anthropic requests python-dateutil
      
      - name: Run PM Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          NOTION_METRICS_DB_ID: ${{ secrets.NOTION_METRICS_DB_ID }}
        run: |
          python agents/pm_agent.py
      
      - name: Create Standup Issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import requests
          from datetime import datetime
          
          # Read the report
          with open('standup_report.md', 'r') as f:
              report = f.read()
          
          today = datetime.now().strftime('%Y-%m-%d')
          
          # Create issue
          repo = os.environ['GITHUB_REPOSITORY']
          token = os.environ['GITHUB_TOKEN']
          
          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json"
          }
          
          payload = {
              "title": f"ðŸ“Š Daily Standup Report - {today}",
              "body": report,
              "labels": ["standup", "pm-report"]
          }
          
          response = requests.post(
              f"https://api.github.com/repos/{repo}/issues",
              headers=headers,
              json=payload
          )
          
          if response.status_code == 201:
              print("âœ… Standup report issue created!")
          else:
              print(f"âš ï¸ Failed to create issue: {response.status_code}")
          PYTHON_SCRIPT
