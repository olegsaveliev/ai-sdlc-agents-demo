import os
import anthropic
import requests

# Configuration
ANTHROPIC_API_KEY = os.environ['ANTHROPIC_API_KEY']
GITHUB_TOKEN = os.environ['GITHUB_TOKEN']
GITHUB_REPO = os.environ['GITHUB_REPOSITORY']
PR_NUMBER = os.environ['PR_NUMBER']

def get_pr_changes():
    """Fetch PR file changes"""
    url = f"https://api.github.com/repos/{GITHUB_REPO}/pulls/{PR_NUMBER}/files"
    headers = {
        "Authorization": f"Bearer {GITHUB_TOKEN}",
        "Accept": "application/vnd.github+json"
    }
    response = requests.get(url, headers=headers)
    data = response.json()
    
    # Handle edge cases
    if isinstance(data, dict):
        print(f"Warning: Unexpected response format: {data}")
        return []
    
    return data

def generate_tests(changes):
    """Use Claude to generate test cases based on code changes"""
    client = anthropic.Anthropic(api_key=ANTHROPIC_API_KEY)
    
    # Get file contents
    files_content = []
    for file in changes[:3]:  # Limit to first 3 files
        if file['filename'].endswith('.py'):
            files_content.append(f"File: {file['filename']}\n{file.get('patch', '')}")
    
    if not files_content:
        print("No Python files to test")
        return None
    
    prompt = f"""You are a QA Engineer AI agent. Generate comprehensive pytest test cases for the following code changes.

**Code Changes:**
{chr(10).join(files_content)}

**Your task:**
1. Create pytest test cases covering:
   - Happy path scenarios
   - Edge cases
   - Error conditions
   - Boundary values

2. Use pytest fixtures where appropriate
3. Include clear test names and docstrings
4. Mock external dependencies if needed

**IMPORTANT:**
- Generate ONLY valid Python code
- Ensure all docstrings are properly closed with triple quotes
- Do not include any explanatory text outside the code
- Make sure all functions are complete
- Include all necessary imports at the top

Generate the complete test file ready to run with pytest."""

    message = client.messages.create(
        model="claude-sonnet-4-20250514",
        max_tokens=3000,
        messages=[{"role": "user", "content": prompt}]
    )
    
    return message.content[0].text

def save_tests(test_code):
    """Save generated tests to file"""
    os.makedirs('tests', exist_ok=True)
    
    # Clean up code block markers if present
    if '```python' in test_code:
        test_code = test_code.split('```python')[1].split('```')[0].strip()
    elif '```' in test_code:
        test_code = test_code.split('```')[1].split('```')[0].strip()
    
    # Validate the syntax before saving
    try:
        compile(test_code, '<string>', 'exec')
        print("‚úÖ Test code syntax is valid")
    except SyntaxError as e:
        print(f"‚ö†Ô∏è Syntax error in generated tests: {e}")
        print("Attempting to fix...")
        
        # Try to fix common issues
        lines = test_code.split('\n')
        fixed_lines = []
        in_docstring = False
        docstring_quotes = None
        
        for line in lines:
            # Track docstrings
            if '"""' in line or "'''" in line:
                if not in_docstring:
                    in_docstring = True
                    docstring_quotes = '"""' if '"""' in line else "'''"
                elif docstring_quotes in line:
                    in_docstring = False
                    docstring_quotes = None
            
            fixed_lines.append(line)
        
        # If still in docstring at end, close it
        if in_docstring and docstring_quotes:
            fixed_lines.append(docstring_quotes)
        
        test_code = '\n'.join(fixed_lines)
        
        # Try compiling again
        try:
            compile(test_code, '<string>', 'exec')
            print("‚úÖ Fixed syntax errors")
        except SyntaxError:
            print("‚ùå Could not fix syntax errors automatically")
            # Create a minimal valid test file instead
            test_code = '''import pytest

def test_placeholder():
    """Placeholder test - original generated tests had syntax errors"""
    assert True, "QA Agent generated tests with syntax errors, needs manual review"
'''
    
    with open('tests/test_generated.py', 'w') as f:
        f.write(test_code)
    
    print(f"‚úÖ Tests saved to tests/test_generated.py")

def post_qa_analysis(test_summary):
    """Post QA analysis to PR"""
    url = f"https://api.github.com/repos/{GITHUB_REPO}/issues/{PR_NUMBER}/comments"
    headers = {
        "Authorization": f"Bearer {GITHUB_TOKEN}",
        "Accept": "application/vnd.github+json"
    }
    
    body = f"""## üß™ QA Agent Analysis

**Test Coverage Generated:**
{test_summary}

**Next Steps:**
- ‚úÖ Automated tests have been generated
- üîç Review test cases for completeness
- üöÄ Tests will run automatically

---
*Generated by QA Agent*"""
    
    requests.post(url, headers=headers, json={"body": body})

def main():
    print(f"ü§ñ QA Agent starting for PR #{PR_NUMBER}...")
    
    # Get PR changes
    changes = get_pr_changes()
    
    # Check if we got valid data
    if not changes:
        print("‚ö†Ô∏è No changes found or error fetching PR")
        test_summary = "No files to analyze"
        post_qa_analysis(test_summary)
        return
    
    print(f"üìù Found {len(changes)} changed files")
    
    # Generate tests
    test_code = generate_tests(changes)
    
    if test_code:
        save_tests(test_code)
        test_summary = f"Generated comprehensive test suite ({len(test_code)} characters)"
        print(f"‚úÖ {test_summary}")
    else:
        test_summary = "No Python files requiring tests"
        print(f"‚ö†Ô∏è {test_summary}")
    
    # Post analysis
    post_qa_analysis(test_summary)
    print("‚úÖ QA Agent completed successfully!")

if __name__ == "__main__":
    main()
